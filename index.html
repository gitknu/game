<!DOCTYPE html>
<html lang="eng">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <meta name="screen-orientation" content="landscape">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Nu, pogodi!">
    <meta property="og:title" content="Nu, pogodi! browser game."/>
    <meta property="og:image" content="https://hanka8.github.io/Nu-pogodi/assets/Screenshot.bmp" />
    <link rel="apple-touch-icon" href="https://hanka8.github.io/Nu-pogodi/assets/favicon32.png">
    <link rel="shortcut icon" href="https://hanka8.github.io/Nu-pogodi/assets/favicon32.png" type="image/x-icon">
    <title>Nu, pogodi!</title>
    <style>
        /* CODE 1: Base styles for container, buttons, and adaptiveness */
        :root {
            --multiplier: 1.8;
            --fontSize: calc(15px*var(--multiplier));
            --gameContainerWidth: calc(520px*var(--multiplier));
            --gameContainerHeight: calc(337px*var(--multiplier));
            --startBtnsBoxX: calc(446px*var(--multiplier));
            --startBtnsBoxY: calc(36px*var(--multiplier));
            --startBtnWidth: calc(24px*var(--multiplier));
            --startBtnHeight: calc(14px*var(--multiplier));
            --directionBtnWidth: calc(28px*var(--multiplier));
            --directionBtnHeight: calc(28px*var(--multiplier));
            --directionBtnOutlineWidth: calc(5px*var(--multiplier));
            --directionBtnBorderWidth: calc(2px*var(--multiplier));
            --leftTopBtnX: calc(38px*var(--multiplier));
            --leftTopBtnY: calc(176px*var(--multiplier));
            --rightTopBtnX: calc(446px*var(--multiplier));
            --rightTopBtnY: calc(176px*var(--multiplier));
            --leftBottomBtnX: calc(38px*var(--multiplier));
            --leftBottomBtnY: calc(234px*var(--multiplier));
            --rightBottomBtnX: calc(446px*var(--multiplier));
            --rightBottomBtnY: calc(234px*var(--multiplier));
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black; /* Base background color */
            font-family: 'Alegreya Sans SC', Tahoma, Arial, sans-serif;
            position: relative; /* Needed for z-index stacking */
            z-index: 0;
        }
        .game-container {
            position: relative;
            text-align: center;
            width: var(--gameContainerWidth);
            height: var(--gameContainerHeight);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            /* FIX: Background color remains, but image is moved to an overlay */
            background-color:rgb(0, 0, 0);
        }
        /* ADDED: New element for the background plate */
        #background-plate {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #b5b5b5;
            z-index: 0;
            border-radius: 20px;
        }
        /* FIX: New pseudo-element to act as the overlay */
        .game-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url(https://hanka8.github.io/Nu-pogodi/assets/game-pad-background-3.png);
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 2; /* Puts the overlay above the colored rectangles */
            pointer-events: none; /* Allows clicks to go through the overlay to the buttons */
        }
        /* ADDED: Colored rectangles to cover the sides */
        #left-cover, #right-cover {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: #182917;
            z-index: 1; /* Positioned below the console image, but above the background plate */
        }
        #left-cover {
            left: 0;
            width: calc(138px * var(--multiplier));
        }
        #right-cover {
            right: 0;
            width: calc(139px * var(--multiplier));
        }
        .start-btns-box {
            position: absolute;
            left: var(--startBtnsBoxX);
            top: var(--startBtnsBoxY);
            display: flex;
            flex-direction: column;
            z-index: 3; /* Ensure buttons are on top of the overlay and covers */
        }
        .start-btn {
            width: var(--startBtnWidth);
            height: var(--startBtnHeight);
            cursor: pointer;
            border-radius: 20px;
            border-width: calc(var(--startBtnWidth)/18);
            border-color: rgb(70, 70, 62);
            border-style: none;
            border-bottom-style: solid;
            border-left-style: solid;
            background: linear-gradient(to top right, rgb(80, 78, 78), rgb(221, 219, 219) 90%);
            outline-color: #ae1921;
            outline-style: solid;
            outline-width: calc(var(--startBtnWidth)/9);
        }
        .start-btn:hover {
            background: linear-gradient(to top right, rgb(66, 64, 64), rgb(221, 219, 219) 98%);
        }
        .start-btn:active {
            background: linear-gradient(to top right, rgb(66, 64, 64), rgb(221, 219, 219) 98%);
            border-style: solid;
            border-width: calc(var(--startBtnWidth)/20);
        }
        .start-btn-caption {
            font-size: 1.3rem;
            font-weight: bold;
            color: #000;
            margin-top: 18%;
            margin-bottom: 28%;
        }
        @keyframes glowing-animation {
            0%, 100% {
                box-shadow: 0 0 5px #ae1921, 0 0 10px #ae1921;
            }
            50% {
                box-shadow: 0 0 20px #cd222d, 0 0 30px #cd222d;
            }
        }
        .start-btn.glowing-hint {
            animation: glowing-animation 1.5s ease-in-out;
        }
        .direction-btn {
            border-radius: 50%;
            cursor: pointer;
            position: absolute;
            width: var(--directionBtnWidth);
            height: var(--directionBtnHeight);
            outline-width: var(--directionBtnOutlineWidth);
            outline-color: #cd222d;
            outline-style: solid;
            border-width: var(--directionBtnBorderWidth);
            border-style: solid;
            border-color: #692424;
            border-top: none;
            border-right: none;
            background: linear-gradient(to top right, #520000, #cd222d 50%, #ecdfdf 95%);
            z-index: 3; /* Ensure buttons are on top of the overlay and covers */
        }
        .direction-btn:hover {
            background: linear-gradient(to top right, #520000, #cd222d 55%, #ecdfdf 99%);
        }
        .direction-btn:active {
            background: linear-gradient(to top right, #520000, #cd222d 55%, #ecdfdf 99%);
            border-style: solid;
            border-color: #692424;
            border-width: calc(var(--directionBtnBorderWidth)/1.5);
        }
        #leftTopBtn {
            left: var(--leftTopBtnX);
            top: var(--leftTopBtnY);
        }
        #rightTopBtn {
            left: var(--rightTopBtnX);
            top: var(--rightTopBtnY);
        }
        #leftBottomBtn {
            left: var(--leftBottomBtnX);
            top: var(--leftBottomBtnY);
        }
        #rightBottomBtn {
            left: var(--rightBottomBtnX);
            top: var(--rightBottomBtnY);
        }
        #modal, #instructionsModal {
            opacity: 0;
            position: absolute;
            inset: 0;
            top: -100%;
            transition: 300ms;
            background-image: url('https://img.freepik.com/free-vector/blank-white-notepaper-design_53876-118304.jpg');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-radius: 10px;
            color: #2c2c2c;
            display: block;
            /* MODIFIED: Increased width and adjusted padding */
            width: calc(var(--gameContainerWidth) * 0.9);
            height: calc(var(--gameContainerHeight) * 0.7);
            padding: 12% 10%;
            left: 50%;
            translate: -50% 0;
            z-index: 4;
            text-align: center;
            display: flex;
            align-items: center;
            font-size: calc(1.5rem * var(--multiplier));
            font-family: 'Courier New', Courier, 'Lucida Sans Typewriter', 'Lucida Typewriter', monospace;
        }
        #modal.shown, #instructionsModal.shown {
            opacity: 1;
            top: 50%;
            transition: 300ms;
            translate: -50% -50%;
        }
        #modal.shown #closeModalBtn, #instructionsModal.shown #closeInstructionsModalBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 14%;
            height: 14%;
            cursor: pointer;
            filter: invert(15%) sepia(90%) saturate(5000%) hue-rotate(350deg) brightness(70%) contrast(150%) drop-shadow(0 0 1px rgba(200,0,0,0.5));
        }
        /* Styles for the audio control buttons to look like BLUE soap bubbles */
        .audio-control-btn {
            position: fixed;
            width: calc(var(--directionBtnWidth) * 1.5);
            height: calc(var(--directionBtnHeight) * 1.5);
            background: radial-gradient(circle at 30% 30%, rgba(170, 210, 255, 0.8), rgba(65, 105, 225, 0.4) 80%); /* Blueish gradient */
            border: 2px solid rgba(200, 225, 255, 0.7); /* Lighter blue border */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25), inset 0 3px 6px rgba(135, 206, 250, 0.6); /* Sky blue inner highlight */
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ffffff; /* White icons for better contrast on blue */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); /* Add shadow to icon */
            transition: all 0.2s ease-out; /* Unified transition */
        }
        .audio-control-btn:hover {
            background: radial-gradient(circle at 30% 30%, rgba(190, 225, 255, 0.9), rgba(85, 125, 245, 0.5) 80%);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.35), inset 0 3px 6px rgba(175, 226, 255, 0.7);
            transform: scale(1.05); /* Slightly enlarge on hover */
        }
        .audio-control-btn:active {
            transform: scale(0.9);
            transition-duration: 0.1s;
        }
        /* Base styles for BOTH pseudo-elements for stacking and centering */
        #audioPlayBtn::before,
        #audioPlayBtn::after {
            /* Stacking */
            position: absolute;
            top: 50%;
            left: 50%;
            /* Smooth transition */
            transition: opacity 0.3s ease-in-out;
        }
        /* Play Icon (using ::before) */
        #audioPlayBtn::before {
            content: '♬';
            font-size: calc(var(--directionBtnWidth) / 1.5);
            /* Centering and original offset */
            transform: translate(-50%, -50%) translateX(10%);
            opacity: 1; /* Initially visible */
        }
        /* Pause Icon (using ::after) */
        #audioPlayBtn::after {
            content: '❚❚';
            font-size: calc(var(--directionBtnWidth) / 2);
            /* Centering and original offset */
            transform: translate(-50%, -50%) translateX(0);
            opacity: 0; /* Initially hidden */
        }
        /* When .playing class is added */
        #audioPlayBtn.playing::before {
            opacity: 0; /* Fade out play icon */
        }
        #audioPlayBtn.playing::after {
            opacity: 1; /* Fade in pause icon */
        }
        #audioRestartBtn, #audioDownloadBtn {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        #audioDownloadBtn {
            transition-delay: 0.1s;
        }
        #audioRestartBtn.visible, #audioDownloadBtn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        /* FIXED: Added a more specific rule to ensure the press animation applies to all buttons */
        #audioRestartBtn.visible:active,
        #audioDownloadBtn.visible:active {
            transform: scale(0.9);
            transition-duration: 0.1s;
        }
        #audioRestartBtn::after {
            content: '↺';
            font-size: calc(var(--directionBtnWidth) / 1.5);
            font-weight: bold;
        }
        #audioDownloadBtn::after {
            content: '⤓'; /* Download icon */
            font-size: calc(var(--directionBtnWidth) / 1.5);
            font-weight: bold;
        }
        /* ADDED: Keyframes and class for the blue button hint */
        @keyframes glowing-blue-animation {
            0%, 100% {
                box-shadow: 0 0 5px #6495ED, 0 0 10px #6495ED, inset 0 3px 6px rgba(135, 206, 250, 0.6);
            }
            50% {
                box-shadow: 0 0 20px #4169E1, 0 0 30px #4169E1, inset 0 3px 6px rgba(175, 226, 255, 0.7);
            }
        }
        .audio-control-btn.glowing-blue-hint {
            animation: glowing-blue-animation 1.5s ease-in-out;
        }
        #handGif {
            position: absolute;
            height: auto;
            z-index: 3;
            display: none; /* Managed by JS based on screen space */
            pointer-events: none; /* Cannot be interacted with */
            transform: rotate(90deg); /* Rotated the GIF */
            opacity: 0; /* Start invisible for fade-in */
            transition: opacity 0.5s ease-in-out;
            filter: invert(1); /* Inverts the color of the GIF */
        }
        #handGif.visible {
            opacity: 0.5;
        }
        @media (max-width:870px) {
            .start-btn-caption {
                font-size: 1rem;
            }
        }
        @media (max-width:620px) {
            .start-btn-caption {
                font-size: 0.8rem;
            }
        }
        @media (max-width:520px) {
            .start-btn-caption {
                font-size: 0.5rem;
            }
        }
        /* CODE 2: Styles for the new game screen */
        /* FIXED: Switched to absolute positioning for more robust centering on all devices. */
        #game-wrap {
            width: 572px;
            height: 350px;
            background: transparent url('https://gitknu.github.io/game/wolf_cleanup.png') center center no-repeat;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            z-index: 0; /* Position the game screen behind the overlay */
        }
        
        /* --- MODIFIED: Styles for the "off" state and blink animations --- */
        @keyframes blink-on {
            /* ON for 0.5s */
            0%      { opacity: 1; }
            33.33%  { opacity: 1; }

            /* OFF for 0.25s */
            33.34%  { opacity: 0; }
            50%     { opacity: 0; }

            /* ON for 0.5s */
            50.01%  { opacity: 1; }
            83.33%  { opacity: 1; }

            /* OFF for 0.25s */
            83.34%  { opacity: 0; }
            99.9%   { opacity: 0; }

            /* Final permanent ON state */
            100%    { opacity: 1; }
        }

        /* ADDED: Blink-off animation */
        @keyframes blink-off {
            /* Starts ON */
            0%, 25% { opacity: 1; }

            /* Blink 1 OFF */
            25.01%, 50% { opacity: 0; }

            /* Blink 2 ON */
            50.01%, 75% { opacity: 1; }

            /* Stays OFF */
            75.01%, 100% { opacity: 0; }
        }

        /* Initially hide the elements */
        #game-wrap.game-off .wolf,
        #game-wrap.game-off .basket,
        #game-wrap.game-off #score,
        #game-wrap.game-off #loss {
            opacity: 0;
        }

        /* When the game turns on, apply the blink-on animation */
        #game-wrap.game-on .wolf,
        #game-wrap.game-on .basket,
        #game-wrap.game-on #score,
        #game-wrap.game-on #loss {
            animation: blink-on 1.5s forwards;
        }

        /* ADDED: Apply blink-off animation */
        #game-wrap.game-blinking-off .wolf,
        #game-wrap.game-blinking-off .basket,
        #game-wrap.game-blinking-off #score,
        #game-wrap.game-blinking-off #loss {
            animation: blink-off 1.5s forwards;
        }
        /* --- END of "off" state styles --- */

        #game-wrap .basket {
            width: 80px;
            height: 80px;
            position: absolute;
        }
        #game-wrap[data-bx="0"][data-by="1"] .basket {
            width: 82px;
            height: 78px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/basket/basket-p-0-1.png') center center no-repeat;
            top: 158px;
            left: 126px;
        }
        #game-wrap[data-bx="1"][data-by="1"] .basket {
            width: 82px;
            height: 78px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/basket/basket-p-1-1.png') center center no-repeat;
            top: 165px;
            right: 123px;
        }
        #game-wrap[data-bx="0"][data-by="0"] .basket {
            width: 85px;
            height: 65px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/basket/basket-p-0-0.png') center center no-repeat;
            left: 124px;
            bottom: 50px;
        }
        #game-wrap[data-bx="1"][data-by="0"] .basket {
            width: 85px;
            height: 65px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/basket/basket-p-1-0.png') center center no-repeat;
            right: 126px;
            bottom: 44px;
        }
        #game-wrap .wolf {
            width: 50px;
            height: 140px;
            position: absolute;
        }
        #game-wrap[data-bx="0"] .wolf {
            width: 98px;
            height: 152px;
            top: 164px;
            left: 179px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/wolf/wolf-p-0.png') center center no-repeat;
        }
        #game-wrap[data-bx="1"] .wolf {
            width: 90px;
            height: 146px;
            top: 166px;
            right: 186px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/wolf/wolf-p-1.png') center center no-repeat;
        }
        #game-wrap .egg {
            width: 15px;
            height: 15px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/egg/egg.png') center center no-repeat;
            position: absolute;
        }
        #game-wrap[data-egg-0="0"] .egg.e-0,
        #game-wrap[data-egg-1="0"] .egg.e-1,
        #game-wrap[data-egg-2="0"] .egg.e-2,
        #game-wrap[data-egg-3="0"] .egg.e-3 {
            display: none;
        }
        #game-wrap[data-egg-0="1"] .egg.e-0 { top: 195px; left: 47px; transform: rotate(65deg); }
        #game-wrap[data-egg-0="2"] .egg.e-0 { top: 205px; left: 62px; transform: rotate(118deg); }
        #game-wrap[data-egg-0="3"] .egg.e-0 { top: 215px; left: 79px; transform: rotate(162deg); }
        #game-wrap[data-egg-0="4"] .egg.e-0 { top: 223px; left: 96px; transform: rotate(-93deg); }
        #game-wrap[data-egg-0="5"] .egg.e-0 { top: 235px; left: 108px; transform: rotate(-7deg); }
        #game-wrap[data-egg-1="1"] .egg.e-1 { top: 122px; left: 47px; transform: rotate(56deg); }
        #game-wrap[data-egg-1="2"] .egg.e-1 { top: 132px; left: 62px; transform: rotate(108deg); }
        #game-wrap[data-egg-1="3"] .egg.e-1 { top: 142px; left: 80px; transform: rotate(192deg); }
        #game-wrap[data-egg-1="4"] .egg.e-1 { top: 151px; left: 95px; transform: rotate(-62deg); }
        #game-wrap[data-egg-1="5"] .egg.e-1 { top: 160px; left: 110px; }
        #game-wrap[data-egg-2="1"] .egg.e-2 { top: 122px; right: 51px; transform: rotate(-10deg); }
        #game-wrap[data-egg-2="2"] .egg.e-2 { top: 132px; right: 66px; transform: rotate(-56deg); }
        #game-wrap[data-egg-2="3"] .egg.e-2 { top: 142px; right: 84px; transform: rotate(-128deg); }
        #game-wrap[data-egg-2="4"] .egg.e-2 { top: 149px; right: 99px; transform: rotate(140deg); }
        #game-wrap[data-egg-2="5"] .egg.e-2 { top: 160px; right: 113px; transform: rotate(58deg); }
        #game-wrap[data-egg-3="1"] .egg.e-3 { top: 195px; right: 50px; transform: rotate(-14deg); }
        #game-wrap[data-egg-3="2"] .egg.e-3 { top: 204px; right: 66px; transform: rotate(-53deg); }
        #game-wrap[data-egg-3="3"] .egg.e-3 { top: 215px; right: 83px; transform: rotate(-96deg); }
        #game-wrap[data-egg-3="4"] .egg.e-3 { top: 223px; right: 100px; transform: rotate(152deg); }
        #game-wrap[data-egg-3="5"] .egg.e-3 { top: 235px; right: 112px; transform: rotate(68deg); }
        #game-wrap #score {
            position: absolute;
            top: 48px;
            left: 326px;
        }
        #game-wrap #score ul {
            margin: 0;
            padding: 0;
            list-style: none;
            display: inline-block;
        }
        #game-wrap #score ul > li {
            width: 31px;
            height: 47px;
            margin: 0 0 0 -2px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/score/num-bg.png');
            display: inline-block;
            vertical-align: top;
        }
        #game-wrap #score ul > li span {
            width: 100%;
            height: 100%;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/score/nums.png');
            background-position: 0px 0px;
            text-indent: -200px;
            display: block;
            overflow: hidden;
        }
        #game-wrap #score ul > li.n-0 span { background-position: 0px 0px; }
        #game-wrap #score ul > li.n-1 span { background-position: -31px 0px; }
        #game-wrap #score ul > li.n-2 span { background-position: -62px 0px; }
        #game-wrap #score ul > li.n-3 span { background-position: -93px 0px; }
        #game-wrap #score ul > li.n-4 span { background-position: -124px 0px; }
        #game-wrap #score ul > li.n-5 span { background-position: -155px 0px; }
        #game-wrap #score ul > li.n-6 span { background-position: -186px 0px; }
        #game-wrap #score ul > li.n-7 span { background-position: -217px 0px; }
        #game-wrap #score ul > li.n-8 span { background-position: -248px 0px; }
        #game-wrap #score ul > li.n-9 span { background-position: -279px 0px; }
        #game-wrap #loss {
            width: 114px;
            height: 32px;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/loss/loss.png') left top no-repeat;
            position: absolute;
            top: 114px;
            left: 326px;
        }
        #game-wrap[data-loss="0"] #loss { width: 0; }
        #game-wrap[data-loss="1"] #loss { width: 40px; }
        #game-wrap[data-loss="2"] #loss { width: 80px; }
        #game-wrap[data-loss="3"] #loss { width: 120px; }
        #message {
            width: 100%;
            height: 100%;
            background: transparent url('https://shtange.github.io/catch-the-egg/img/game-over-bg.png');
            position: absolute;
            top: 0; left: 0;
            display: none;
            overflow: hidden;
            color: #E0E0D5;
        }
        #message > div {
            margin-top: 134px;
            padding: 5px 0 15px;
            background: #564E47;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.1) inset;
        }
        #message > div h3 {
            font-size: 28px;
            line-height: 1.5em;
            font-weight: normal;
        }
        #message > div p {
            font-size: 16px;
        }

        /* --- ADDED: BUBBLE STYLES --- */
        #bubble-container {
            position: fixed;
            bottom: 0;
            left: 50px;
            width: 250px;
            height: 300px;
            opacity: 0; /* Hidden by default */
            pointer-events: none; /* Make it non-interactive */
            z-index: 0; /* Position it behind the game console but above the water */
            transition: opacity 0.5s ease-out;
        }
        /* Only show bubbles when the 'active' class is present */
        #bubble-container.active {
            opacity: 1;
        }
        #bubble-container svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        .ocean-bubble {
            fill: #fefefe;
            opacity: 0;
            animation: bubble-drift 7s infinite;
        }
        .ocean-bubble:nth-child(1) {
            animation-delay: 1.2s;
        }
        .ocean-bubble:nth-child(2) {
            animation-delay: 2.5s;
        }
        .ocean-bubble:nth-child(3) {
            animation-delay: 3.8s;
        }
        .ocean-bubble:nth-child(4) {
            animation-delay: 4.3s;
        }
        .ocean-bubble:nth-child(5) {
            animation-delay: 5.1s;
        }
        .ocean-bubble:nth-child(6) {
            animation-delay: 6.9s;
        }
        .ocean-bubble:nth-child(7) {
            animation-delay: 7.4s;
        }
        .ocean-bubble:nth-child(8) {
            animation-delay: 8.7s;
        }
        .ocean-bubble:nth-child(9) {
            animation-delay: 9.2s;
        }
        @keyframes bubble-drift {
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: scale(0.8) translateY(-100%);
            }
        }
        
        /* --- MODIFIED: WAVE & WATER STYLES --- */
        #water-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(100vh + 100px); /* Increased height to hide waves above screen */
            background: linear-gradient(to top, #001f3f, #005aa7);
            z-index: -1;
            pointer-events: none;
            /* Initially hidden below the screen AND invisible */
            transform: translateY(100%);
            opacity: 0;
            /* Smooth transition for BOTH properties */
            transition: transform 2.5s ease-out, opacity 2s ease-out;
        }
        /* When active, slide the water and waves up and fade them in */
        body.underwater-active #water-container {
            transform: translateY(0); /* MODIFIED: Transition to its natural position */
            opacity: 1;
        }
        .waves {
            position: absolute;
            top: -1px; /* Overlap slightly to prevent a seam */
            left: 0;
            width: 100%;
            height: 100px;
        }
        .waves svg {
            position: absolute;
            bottom: 0;
            left: 0;
        }
        .waves use {
            animation: wavewave 5s cubic-bezier(0.55, 0.5, 0.45, 0.5) infinite;
            fill: #005aa7; /* Match the top color of the gradient for a seamless look */
            opacity: 0.7;
        }
        .waves.back use:nth-child(2) {
            animation-delay: -4s;
            animation-duration: 13s;
        }
        .waves.back use:nth-child(3) {
            animation-delay: -5s;
            animation-duration: 20s;
        }
        .waves.front use:nth-child(2) {
            animation-delay: -2s;
            animation-duration: 7s;
        }
        .waves.front use:nth-child(3) {
            animation-delay: -3s;
            animation-duration: 10s;
        }
        @keyframes wavewave {
            0% {
                transform: translate(-90px);
            }
            100% {
                transform: translate(85px);
            }
        }
    </style>
</head>
<body>
    <img id="handGif" src="https://assets-v2.lottiefiles.com/a/9c2e0fac-fab1-11ee-9d90-fb745f82b8ef/yK1BpXRwMW.gif" alt="Pointing Hand">
    <button id="audioPlayBtn" class="audio-control-btn"></button>
    <button id="audioRestartBtn" class="audio-control-btn"></button>
    <button id="audioDownloadBtn" class="audio-control-btn"></button>
    <audio id="backgroundAudio" src="https://gitknu.github.io/game/audio_inst.wav" loop></audio>
    <main class="game-container">
        <div id="background-plate"></div>
        <div id="left-cover"></div>
        <div id="right-cover"></div>
        <div class="start-btns-box">
            <button id="startBtn1" class="start-btn"></button>
            <p class="start-btn-caption">игра A</p>
            <button id="startBtn2" class="start-btn"></button>
            <p class="start-btn-caption">игра Б</p>
        </div>
        <!-- MODIFIED: Added the 'game-off' class to hide elements initially -->
        <div id="game-wrap" class="game-off" data-bx="0" data-by="1" data-egg-0="0" data-egg-1="0" data-egg-2="0" data-egg-3="0" data-loss="0">
            <div class="basket"></div>
            <div class="wolf"></div>
            <div class="egg e-0"></div>
            <div class="egg e-1"></div>
            <div class="egg e-2"></div>
            <div class="egg e-3"></div>
            <div id="score">
                <ul>
                    <li class="n-0"><span>0</span></li>
                    <li class="n-0"><span>0</span></li>
                    <li class="n-0"><span>0</span></li>
                    <li class="n-0"><span>0</span></li>
                </ul>
            </div>
            <div id="loss"></div>
            <div id="message"></div>
        </div>
        <button id="leftTopBtn" class="direction-btn"></button>
        <button id="leftBottomBtn" class="direction-btn"></button>
        <button id="rightTopBtn" class="direction-btn"></button>
        <button id="rightBottomBtn" class="direction-btn"></button>
    </main>
    <div id="modal">
        <p>Будь ласка, увімкніть авто-поворот та поверніть телефон горизонтально. Дякую!</p>
        <img id="closeModalBtn" src="https://hanka8.github.io/Nu-pogodi/assets/close.svg" alt="close">
    </div>

    <!-- ADDED: New instructions modal -->
    <div id="instructionsModal">
        <!-- MODIFIED: Updated the instructional text with line breaks -->
        <p>Зробіть свайп знизу вгору<br>(у лівій частині екрану).<br><br>Далі увімкніть гру<br>(та музику за бажанням).<br><br>Підказки на екрані покажуть як ☺</p>
        <img id="closeInstructionsModalBtn" src="https://hanka8.github.io/Nu-pogodi/assets/close.svg" alt="close">
    </div>

    <!-- ADDED: BUBBLES HTML -->
    <div id="bubble-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 365.91 430.96">
            <circle cx="25" cy="296.6" r="12" class="ocean-bubble"/>
            <circle cx="15" cy="296.6" r="8" class="ocean-bubble"/>
            <circle cx="25" cy="296.6" r="10" class="ocean-bubble"/>
            <circle cx="35" cy="296.6" r="8.76" class="ocean-bubble"/>
            <circle cx="16" cy="296.6" r="15.25" class="ocean-bubble"/>
            <circle cx="85" cy="296.6" r="35.76" class="ocean-bubble"/>
            <circle cx="50" cy="296.6" r="18.68" class="ocean-bubble"/>
            <circle cx="30" cy="296.6" r="24.14" class="ocean-bubble"/>
            <circle cx="15" cy="290" r="19" class="ocean-bubble"/>
        </svg>
    </div>

    <!-- MODIFIED: Water and Waves HTML -->
    <div id="water-container">
        <div class="waves back">
            <svg viewBox="0 24 150 28" preserveAspectRatio="none">
                <defs>
                    <path id="gentle-wave-back" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
                </defs>
                <use xlink:href="#gentle-wave-back" x="48" y="5"></use>
                <use xlink:href="#gentle-wave-back" x="48" y="7"></use>
            </svg>
        </div>
        <div class="waves front">
            <svg viewBox="0 24 150 28" preserveAspectRatio="none">
                <defs>
                    <path id="gentle-wave-front" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
                </defs>
                <use xlink:href="#gentle-wave-front" x="48" y="0"></use>
                <use xlink:href="#gentle-wave-front" x="48" y="3"></use>
            </svg>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const gameContainerElement = document.querySelector('.game-container');
        const gameWrapElement = document.getElementById("game-wrap");
        const scoreListElement = document.querySelector("#score ul");
        const modalElement = document.getElementById("modal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        // ADDED: Elements for the new instructions modal
        const instructionsModalElement = document.getElementById("instructionsModal");
        const closeInstructionsModalBtn = document.getElementById("closeInstructionsModalBtn");
        const startBtn1 = document.getElementById("startBtn1");
        const startBtn2 = document.getElementById("startBtn2");
        const leftTopBtn = document.getElementById("leftTopBtn");
        const leftBottomBtn = document.getElementById("leftBottomBtn");
        const rightTopBtn = document.getElementById("rightTopBtn");
        const rightBottomBtn = document.getElementById("rightBottomBtn");
        const handGif = document.getElementById("handGif");
        // Audio elements
        const audioPlayBtn = document.getElementById("audioPlayBtn");
        const audioRestartBtn = document.getElementById("audioRestartBtn");
        const audioDownloadBtn = document.getElementById("audioDownloadBtn");
        const backgroundAudio = document.getElementById("backgroundAudio");
        const bubbleContainer = document.getElementById("bubble-container");
        backgroundAudio.volume = 0.1; // Set background audio volume to 10%
        let hasAudioBeenPlayed = false; // Flag to track if audio has started
        let hintTimer = null; // Timer for the glowing button hint
        let musicHintTimer = null; // Timer for the music button hint
        let gifHintTimer = null; // Timer for the hint GIF
        let underwaterTimeoutId = null; // Timer for showing bubbles
        // ADDED: Flag to show instructions modal only once
        let hasShownInstructions = false;
        // ADDED: Master flag to control the entire hint sequence
        let hintSequenceHasBeenInitiated = false;


        // --- GAME CONSTANTS ---
        const EGG_FREQUENCY_CHANGE_A = 250;
        const EGG_SPEED_CHANGE_A = 50;
        const EGG_FREQUENCY_CHANGE_B = 300;
        const EGG_SPEED_CHANGE_B = 60;
        const MAX_MULTIPLIER = 1.8;
        const ORIGINAL_GAME_WRAP_WIDTH = 572;
        // --- GAME LOGIC ---
        class Game {
            constructor() {
                this.score = 0;
                this.lives = 0;
                this.eggFrequency = 3000;
                this.eggSpeed = 4000;
                this.wolf = new Wolf();
                this.isEnded = false;
                this.gameStarted = false;
                this.previousEggState = "";
                this.gameType = "A";
                this.intervalId = null;
            }
            start() {
                this.intervalId = setInterval(() => {
                    if (this.isEnded) {
                        clearInterval(this.intervalId);
                        return;
                    }
                    const egg = new Egg();
                    egg.fall();
                    if (this.score % 100 == 0 && this.score > 0) {
                        // Bonus life could be implemented here
                    }
                    if (this.score > 0 && this.score % 10 == 0 && this.eggFrequency >= 800 && this.eggSpeed >= 500) {
                        if (this.gameType == "A") {
                            this.eggFrequency -= EGG_FREQUENCY_CHANGE_A;
                            this.eggSpeed -= EGG_SPEED_CHANGE_A;
                        } else {
                            this.eggFrequency -= EGG_FREQUENCY_CHANGE_B;
                            this.eggSpeed -= EGG_SPEED_CHANGE_B;
                        }
                    }
                }, this.eggFrequency);
            }
            end() {
                this.isEnded = true;
                clearInterval(this.intervalId);
                let gameOverSound = new Audio("https://hanka8.github.io/Nu-pogodi/sounds/gameOver.mp3");
                gameOverSound.play();
                gameWrapElement.classList.add("game-blinking-off");
                setTimeout(() => {
                    gameWrapElement.classList.remove("game-on", "game-blinking-off");
                    gameWrapElement.classList.add("game-off");
                }, 1500);
            }
            // ADDED: Reset method for seamless restart
            reset() {
                clearInterval(this.intervalId);
                this.score = 0;
                this.lives = 0;
                this.eggFrequency = 3000;
                this.eggSpeed = 4000;
                this.isEnded = false;
                this.gameStarted = false;
                this.previousEggState = "";
                this.intervalId = null;
                this.wolf.x = 0;
                this.wolf.y = 1;
                this.wolf.updatePosition();

                const scoreElements = scoreListElement.getElementsByTagName('li');
                for (let i = 0; i < scoreElements.length; i++) {
                    scoreElements[i].className = 'n-0';
                }
                gameWrapElement.setAttribute('data-loss', 0);
                for (let i = 0; i < 4; i++) {
                    gameWrapElement.setAttribute('data-egg-' + i, 0);
                }
            }
            updateScore() {
                this.score += 1;
                let collectSound = new Audio("https://hanka8.github.io/Nu-pogodi/sounds/collect.mp3");
                collectSound.play();
                const scoreString = this.score.toString().padStart(4, '0');
                const scoreElements = scoreListElement.getElementsByTagName('li');
                for (let i = 0; i < scoreElements.length; i++) {
                    scoreElements[i].className = 'n-' + scoreString[i];
                }
            }
            updateLives() {
                this.lives += 1;
                if (this.lives <= 3) {
                    let lifeSound = new Audio("https://hanka8.github.io/Nu-pogodi/sounds/lifeDown.mp3");
                    lifeSound.play();
                    gameWrapElement.setAttribute('data-loss', this.lives);
                }
                if (this.lives >= 3) {
                    this.end();
                }
            }
        }
        class Wolf {
            constructor() {
                this.x = 0;
                this.y = 1;
                this.updatePosition();
            }
            updatePosition() {
                gameWrapElement.setAttribute('data-bx', this.x);
                gameWrapElement.setAttribute('data-by', this.y);
            }
            moveLeft() { this.x = 0; }
            moveRight() { this.x = 1; }
            moveUp() { this.y = 1; }
            moveDown() { this.y = 0; }
            checkCollision(egg) {
                let eggIsLeft = egg.state.includes('left');
                let eggIsTop = egg.state.includes('top');
                let eggX = eggIsLeft ? 0 : 1;
                let eggY = eggIsTop ? 1 : 0;
                if (this.x === eggX && this.y === eggY) {
                    game.updateScore();
                } else {
                    game.updateLives();
                }
            }
        }
        class Egg {
            constructor() {
                let eggOptions = ["bottom-left", "top-left", "top-right", "bottom-right"];
                this.state = eggOptions[Math.floor(Math.random() * eggOptions.length)];
                while (this.state === game.previousEggState) {
                    this.state = eggOptions[Math.floor(Math.random() * eggOptions.length)];
                }
                game.previousEggState = this.state;
                const stateMap = { "bottom-left": 0, "top-left": 1, "top-right": 2, "bottom-right": 3 };
                this.eggIndex = stateMap[this.state];
                this.step = 0;
                this.maxSteps = 5;
            }
            fall() {
                const self = this;
                const interval = setInterval(() => {
                    if (game.isEnded) {
                        clearInterval(interval);
                        gameWrapElement.setAttribute('data-egg-' + self.eggIndex, 0);
                        return;
                    }
                    self.step++;
                    gameWrapElement.setAttribute('data-egg-' + self.eggIndex, self.step);
                    if (self.step > self.maxSteps) {
                        clearInterval(interval);
                        gameWrapElement.setAttribute('data-egg-' + self.eggIndex, 0);
                        game.wolf.checkCollision(self);
                    }
                }, game.eggSpeed / (this.maxSteps + 1));
            }
        }
        // --- INITIALIZE GAME and EVENT LISTENERS ---
        const game = new Game();
        // MODIFIED: Updated function to clear all hint timers and classes, including the master flag
        function clearHint() {
            if (hintTimer) {
                clearTimeout(hintTimer);
                hintTimer = null;
            }
            if (musicHintTimer) {
                clearTimeout(musicHintimer);
                musicHintTimer = null;
            }
            if (gifHintTimer) {
                clearTimeout(gifHintTimer);
                gifHintTimer = null;
            }
            handGif.classList.remove('visible');
            startBtn1.classList.remove('glowing-hint');
            audioPlayBtn.classList.remove('glowing-blue-hint');
            hintSequenceHasBeenInitiated = false; // Reset the master flag
        }
        function handleMove(moveFn1, moveFn2) {
            clearHint();
            if (game.isEnded) return;
            if (!game.gameStarted) {
                gameWrapElement.classList.remove("game-off"); 
                gameWrapElement.classList.add("game-on");
                game.start();
                game.gameStarted = true;
            }
            moveFn1.call(game.wolf);
            moveFn2.call(game.wolf);
            game.wolf.updatePosition();
        }
        leftBottomBtn.addEventListener("click", () => handleMove(game.wolf.moveLeft, game.wolf.moveDown));
        leftTopBtn.addEventListener("click", () => handleMove(game.wolf.moveLeft, game.wolf.moveUp));
        rightBottomBtn.addEventListener("click", () => handleMove(game.wolf.moveRight, game.wolf.moveDown));
        rightTopBtn.addEventListener("click", () => handleMove(game.wolf.moveRight, game.wolf.moveUp));
        
        // MODIFIED: Start button logic to handle seamless restarts
        startBtn1.addEventListener("click", () => {
            clearHint();
            if (game.isEnded || !game.gameStarted) {
                if (game.isEnded) {
                    game.reset();
                }
                gameWrapElement.classList.remove("game-off");
                gameWrapElement.classList.add("game-on");
                game.start();
                game.gameStarted = true;
                game.gameType = "A";
            }
        });
        startBtn2.addEventListener("click", () => {
            clearHint();
            if (game.isEnded || !game.gameStarted) {
                if (game.isEnded) {
                    game.reset();
                }
                gameWrapElement.classList.remove("game-off");
                gameWrapElement.classList.add("game-on");
                game.eggSpeed = 3000;
                game.eggFrequency = 2500;
                game.start();
                game.gameStarted = true;
                game.gameType = "B";
            }
        });
        
        // --- BUBBLE AND WATER ANIMATION LOGIC ---
        function goUnderwater() {
            clearTimeout(underwaterTimeoutId); // Clear any previous timer

            document.body.classList.add('underwater-active');
            // Set a timer to show bubbles *after* the water has risen
            underwaterTimeoutId = setTimeout(() => {
                bubbleContainer.classList.add('active');
            }, 2500); // Match the 2.5s transition time from CSS
        }

        // --- Event listeners for the audio control buttons ---
        audioPlayBtn.addEventListener("click", () => {
            clearHint(); // Clear any pending hints on click
            if (!hasAudioBeenPlayed) {
                audioRestartBtn.classList.add('visible');
                audioDownloadBtn.classList.add('visible');
                hasAudioBeenPlayed = true;
            }

            if (backgroundAudio.paused) {
                backgroundAudio.play();
                audioPlayBtn.classList.add('playing');
                goUnderwater();
            } else {
                backgroundAudio.pause();
                audioPlayBtn.classList.remove('playing');

                // Make the water go down
                document.body.classList.remove('underwater-active');

                // Immediately hide the bubbles
                bubbleContainer.classList.remove('active');

                // IMPORTANT: Cancel any pending command to show the bubbles.
                // This prevents them from appearing after the screen is already black.
                clearTimeout(underwaterTimeoutId);
            }
        });

        audioRestartBtn.addEventListener("click", () => {
            backgroundAudio.currentTime = 0;
            if (backgroundAudio.paused) {
                backgroundAudio.play();
                audioPlayBtn.classList.add('playing');
            }
            // Ensure the underwater sequence runs correctly on restart
            goUnderwater();
        });

        audioDownloadBtn.addEventListener("click", () => {
            const link = document.createElement('a');
            link.href = backgroundAudio.src;
            link.download = 'Nu-pogodi-music.wav'; // The filename for the downloaded file
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- HINT GIF LOGIC ---
        let userHasSwipedUp = false;
        let touchStartX = 0;
        let touchStartY = 0;

        function showGifWithDelay() {
            // If user has already swiped, do not proceed to show the GIF hint.
            if (userHasSwipedUp) return;

            if (gifHintTimer) clearTimeout(gifHintTimer);
            // Check if the element is meant to be displayed (i.e., has space)
            if (window.getComputedStyle(handGif).display !== 'none') {
                gifHintTimer = setTimeout(() => {
                    // Final check before showing, in case the swipe happened during the timeout
                    if (userHasSwipedUp) return;

                    handGif.classList.add('visible');
                    // Add a new timer to hide it after 5 seconds
                    setTimeout(() => {
                        handGif.classList.remove('visible');
                        // Trigger button hint 2 seconds after GIF hint ends
                        if (!game.gameStarted) {
                            hintTimer = setTimeout(() => {
                                // Double-check game hasn't started in the meantime
                                if (!game.gameStarted) {
                                    startBtn1.classList.add('glowing-hint');
                                    setTimeout(() => {
                                        startBtn1.classList.remove('glowing-hint');
                                    }, 1500); // Must match CSS animation duration

                                    // Schedule music button hint 3.5 seconds after red hint ends
                                    musicHintTimer = setTimeout(() => {
                                        if (!game.gameStarted && !hasAudioBeenPlayed) {
                                            audioPlayBtn.classList.add('glowing-blue-hint');
                                            setTimeout(() => {
                                                audioPlayBtn.classList.remove('glowing-blue-hint');
                                            }, 1500); // Must match CSS animation duration
                                        }
                                    }, 1500 + 3500); // 1.5s duration of red hint + 3.5s delay
                                }
                            }, 2000); // 2-second delay after GIF disappears
                        }
                    }, 5000); // GIF is visible for 5 seconds
                }, 2000); // Show after 2 seconds of inactivity
            }
        }

        // --- Touch event listeners for hint interaction ---
        window.addEventListener('touchstart', (e) => {
            // On any touch, immediately hide the GIF and clear its timer
            handGif.classList.remove('visible');
            if (gifHintTimer) clearTimeout(gifHintTimer);

            // Record the starting coordinates if the hint hasn't been permanently disabled yet
            if (!userHasSwipedUp) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
        }, { passive: true });

        window.addEventListener('touchend', (e) => {
            // If the user has already performed the correct swipe, do nothing further.
            if (userHasSwipedUp) return;

            const touchEndY = e.changedTouches[0].clientY;
            const swipeDistanceY = touchStartY - touchEndY; // Positive value indicates an upward swipe
            const swipeDistanceX = Math.abs(touchStartX - e.changedTouches[0].clientX);

            // Check for a distinct "down to up" swipe on the left side of the screen
            if (touchStartX < window.innerWidth / 2 && swipeDistanceY > 50 && swipeDistanceX < 100) {
                // If the swipe is correct, set the flag to permanently disable the GIF hint.
                userHasSwipedUp = true;
            } else {
                // If it was any other touch action (tap, wrong swipe), restart the inactivity timer to show the hint again later.
                tryStartHintSequence();
            }
        }, { passive: true });


        // --- RESPONSIVENESS AND ADAPTIVENESS ---
        function responsibility() {
            // This part scales the outer console to fit the browser window
            const { innerWidth: windowWidth, innerHeight: windowHeight } = window;
            const regex = /\((.*?)px/;
            const containerHeightString = getComputedStyle(document.documentElement).getPropertyValue("--gameContainerHeight");
            const containerWidthString = getComputedStyle(document.documentElement).getPropertyValue("--gameContainerWidth");
            const containerHeight = parseInt(containerHeightString.match(regex)[1]);
            const containerWidth = parseInt(containerWidthString.match(regex)[1]);
            const newMultiplierBasedOnHeight = Math.min(windowHeight / containerHeight, MAX_MULTIPLIER);
            const newMultiplierBasedOnWidth = Math.min(windowWidth / containerWidth, MAX_MULTIPLIER);
            const isNarrow = windowWidth / windowHeight < 1.6;
            let newMultiplier;
            if (windowWidth < 2400) {
                newMultiplier = isNarrow ? newMultiplierBasedOnWidth / 1.1 : newMultiplierBasedOnHeight;
            } else {
                newMultiplier = MAX_MULTIPLIER;
            }
            document.documentElement.style.setProperty("--multiplier", `${newMultiplier}`);
            // This part scales the inner game screen to fit the console's width
            const targetGameWidth = gameContainerElement.offsetWidth * (255 / 520);
            const scaleFactor = targetGameWidth / ORIGINAL_GAME_WRAP_WIDTH;
            // FIXED: Added translate(-50%, -50%) to ensure the game screen stays centered when scaled.
            gameWrapElement.style.transform = `translate(-50%, -50%) scale(${scaleFactor})`;

            // --- CORRECTED BUTTON POSITIONING LOGIC ---
            const consoleRect = gameContainerElement.getBoundingClientRect();
            const midpointOfRightSpace = (consoleRect.right + windowWidth) / 2;
            const buttonRect = audioPlayBtn.getBoundingClientRect();
            const buttonWidth = buttonRect.width;
            const buttonHeight = buttonRect.height;
            const buttonLeftPosition = midpointOfRightSpace - (buttonWidth / 2);
            
            // The vertical gap between buttons will be the same as the gap from the top of the viewport
            const topGap = consoleRect.top;

            // Position the first button (Play)
            const playBtnTop = topGap;
            audioPlayBtn.style.left = `${buttonLeftPosition}px`;
            audioPlayBtn.style.top = `${playBtnTop}px`;

            // Position the second button (Restart) below the first
            const restartBtnTop = playBtnTop + buttonHeight + topGap;
            audioRestartBtn.style.left = `${buttonLeftPosition}px`;
            audioRestartBtn.style.top = `${restartBtnTop}px`;

            // Position the third button (Download) below the second
            const downloadBtnTop = restartBtnTop + buttonHeight + topGap;
            audioDownloadBtn.style.left = `${buttonLeftPosition}px`;
            audioDownloadBtn.style.top = `${downloadBtnTop}px`;

            // --- POSITION AND SIZE THE GIF ---
            const leftSpace = consoleRect.left;
            // Set a minimum space threshold to show the GIF
            if (leftSpace > 100) { 
                handGif.style.display = 'block';
                // Size the GIF to be 80% of the available space for a nice margin
                const gifWidth = leftSpace * 0.8;
                handGif.style.width = `${gifWidth}px`;
                
                // Get the proportional height after setting the width
                const gifHeight = handGif.offsetHeight;
                
                // Vertically center the GIF relative to the console
                const gifTop = consoleRect.top + (consoleRect.height - gifHeight) / 2;
                handGif.style.top = `${gifTop}px`;

                // Horizontally center the GIF in the empty space
                const gifLeft = (leftSpace - gifWidth) / 2;
                handGif.style.left = `${gifLeft}px`;
                
            } else {
                // Hide the GIF if there isn't enough room
                handGif.style.display = 'none';
                handGif.classList.remove('visible'); // Ensure it's visually hidden
                if (gifHintTimer) clearTimeout(gifHintTimer); // Stop the timer
            }
        }
        
        // ADDED: New function to be the single entry point for starting all hint sequences.
        function tryStartHintSequence() {
            // Stop if:
            // - hints have already been initiated
            // - the game is already running
            // - any modal is currently visible
            if (hintSequenceHasBeenInitiated || game.gameStarted || modalElement.classList.contains('shown') || instructionsModalElement.classList.contains('shown')) {
                return;
            }
            // If all checks pass, set the flag and start the sequence.
            hintSequenceHasBeenInitiated = true;
            showGifWithDelay();
        }

        // MODIFIED: This function now only manages modals and clears hints.
        function pleaseRotate() {
            const isMobile = window.innerWidth <= 768;
            const isPortrait = window.innerHeight > window.innerWidth;

            if (isMobile && isPortrait) {
                modalElement.classList.add("shown");
                // If user rotates to portrait, cancel any and all pending hints.
                clearHint();
            } else { 
                modalElement.classList.remove("shown");

                // Show the instructions modal, but only once.
                if (!hasShownInstructions && !game.gameStarted) {
                    instructionsModalElement.classList.add("shown");
                    hasShownInstructions = true;
                }
                
                // Now that modals are handled, attempt to start the hint sequence.
                // It will only run if the conditions are right (e.g., no modals visible).
                tryStartHintSequence();
            }
        }
        closeModalBtn.addEventListener("click", () => {
            modalElement.classList.remove("shown");
        });
        // MODIFIED: Event listener for instructions modal now triggers the hint sequence.
        closeInstructionsModalBtn.addEventListener("click", () => {
            instructionsModalElement.classList.remove("shown");
            // Since the user has closed the last instructional modal, now we can show hints.
            tryStartHintSequence();
        });
        window.addEventListener("resize", () => {
            responsibility();
            pleaseRotate();
        });
        window.addEventListener("load", () => {
            responsibility();
            pleaseRotate();
        });
    </script>
</body>
</html>
